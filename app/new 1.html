<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Controle de Estoque</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
  --accent:#2563eb; --danger:#ef4444; --warn:#f59e0b;
  --card:#1f2937; --line:#334155;
}
* { box-sizing: border-box; }
body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--line); background:rgba(17,24,39,.9); backdrop-filter: blur(4px); position: sticky; top:0; z-index:10; }
header h1 { font-size:18px; margin:0; color:#c7d2fe; }
nav { display:flex; gap:8px; }
nav button { background:transparent; border:0; color:var(--muted); padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:500; }
nav button.active { background: var(--accent); color:white; }
main { max-width:1100px; margin:20px auto; padding:0 16px 40px; display:grid; gap:20px; }
section { background: var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; display:none; }
section.active { display:block; }
h2 { margin:0 0 12px 0; font-size:18px; color:#bfdbfe; }
label { font-size:13px; color: var(--muted); display:block; margin-top:8px; margin-bottom:4px; }
input, select { width:100%; background:#0b1220; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:10px; }
button.action { background: var(--accent); color:white; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; margin-top:10px; }
button.action:disabled { opacity:.6; cursor:not-allowed; }
table { width:100%; border-collapse: collapse; font-size:14px; }
th, td { border-bottom:1px solid var(--line); padding:8px; text-align:left; }
th { background:#1e293b; color:#e2e8f0; position:sticky; top:0; }
.scroll { max-height: 400px; overflow:auto; border:1px solid var(--line); border-radius:8px; }
.status-ok { color:#22c55e; font-weight:600; }
.status-low { color:#f59e0b; font-weight:600; }
.status-crit { color:#ef4444; font-weight:600; }
</style>
</head>
<body>
<header>
  <h1>Controle de Estoque</h1>
  <nav>
    <button data-nav="estoque" class="active">Estoque</button>
    <button data-nav="retirada">Retirada</button>
    <button data-nav="relatorio">Relatório</button>
  </nav>
</header>

<main>
  <!-- Estoque -->
  <section id="sec-estoque" class="active">
    <h2>Estoque Atual</h2>
    <div class="scroll">
      <table id="tabEstoque">
        <thead>
          <tr>
            <th>Código</th><th>Produto</th><th>Quantidade Atual</th><th>Estoque Mínimo</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Retirada -->
  <section id="sec-retirada">
    <h2>Registrar Retirada</h2>
    <label>Produto</label>
    <select id="produtoSelect"></select>
    <label>Quantidade</label>
    <input id="quantidade" type="number" min="1">
    <label>Responsável</label>
    <input id="responsavel">
    <button id="btnRetirada" class="action">Registrar Retirada</button>
  </section>

  <!-- Relatório -->
  <section id="sec-relatorio">
    <h2>Relatório de Retiradas</h2>
    <div class="scroll">
      <table id="tabRelatorio">
        <thead>
          <tr>
            <th>Código</th><th>Produto</th><th>Quantidade Retirada</th><th>Nome do Responsável</th><th>Data e Hora</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbznjI4fjdIdi9L2hDYZ137bAqG-w_TSM89p1YdkWa8n9y1FtG6vgYJ96gQ9J27CkCTJZA/exec";

// Navegação entre abas
document.querySelectorAll("nav button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll("main section").forEach(s=>s.classList.remove("active"));
    document.getElementById("sec-"+btn.dataset.nav).classList.add("active");
  };
});

let estoque = [];

// Carregar estoque
async function fetchStock(){
  const res = await fetch(WEBAPP_URL,{method:"POST", body:JSON.stringify({action:"listStock"})});
  const data = await res.json();
  if(data.success){
    estoque=data.data;
    renderEstoque();
    updateProdutoSelect();
  }
}
function renderEstoque(){
  const tbody=document.querySelector("#tabEstoque tbody");
  tbody.innerHTML="";
  estoque.forEach(it=>{
    let status='<span class="status-ok">OK</span>';
    if(it.quantidade<=it.minimo){
      status = it.quantidade<=0 ? '<span class="status-crit">Crítico</span>' : '<span class="status-low">Abaixo do mínimo</span>';
    }
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${it.codigo}</td><td>${it.produto}</td><td>${it.quantidade}</td><td>${it.minimo}</td><td>${status}</td>`;
    tbody.appendChild(tr);
  });
}
function updateProdutoSelect(){
  const select=document.getElementById("produtoSelect");
  select.innerHTML="";
  estoque.forEach(it=>{
    const opt=document.createElement("option");
    opt.value=it.codigo;
    opt.textContent=`${it.produto} (${it.codigo})`;
    select.appendChild(opt);
  });
}

// Registrar retirada
document.getElementById("btnRetirada").onclick=async()=>{
  const codigo=document.getElementById("produtoSelect").value;
  const quantidade=Number(document.getElementById("quantidade").value);
  const responsavel=document.getElementById("responsavel").value;
  if(!codigo||!quantidade||!responsavel){ alert("Preencha todos os campos"); return; }

  const res=await fetch(WEBAPP_URL,{method:"POST", body:JSON.stringify({action:"retirar",codigo,quantidade,responsavel})});
  const data=await res.json();
  if(data.success){
    alert("Retirada registrada! Novo estoque: "+data.data.novoEstoque);
    fetchStock();
    fetchRelatorio();
  } else alert("Erro: "+data.error);
};

// Relatório
async function fetchRelatorio(){
  const res=await fetch(WEBAPP_URL,{method:"POST", body:JSON.stringify({action:"listRelatorio"})});
  const data=await res.json();
  const tbody=document.querySelector("#tabRelatorio tbody");
  tbody.innerHTML="";
  if(data.success){
    data.data.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.codigo}</td><td>${r.produto}</td><td>${r.quantidade}</td><td>${r.responsavel}</td><td>${r.datahora?new Date(r.datahora).toLocaleString("pt-BR"):""}</td>`;
      tbody.appendChild(tr);
    });
  }
}

// Inicializar
fetchStock();
fetchRelatorio();
</script>
</body>
</html>

